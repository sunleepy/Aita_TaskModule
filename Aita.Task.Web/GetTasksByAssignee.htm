<!DOCTYPE html>
<html>
<head>
    <title>待办任务</title>
    <meta http-equiv="content-Type" content="text/html; charset=UTF-8">
    <link rel="stylesheet" type="text/css" href="http://w.taobao.ali.com/css/comment.css" />
    <!-- task scripts begin -->
    <script type="text/javascript" src="/js/scripts/common.js"></script>
    <script type="text/javascript">
        if (isPhp) {
            currentUserId = '<{$currentUserId}>'; //TODO:Php替换<{$currentUserId}>
        }
        else {
            currentUserId = GetQueryString('userId');
        }
	</script>
    <script type="text/javascript" src="/js/content/jquery/jquery-1.7.2.min.js"></script>
    <script type="text/javascript" src="/js/content/angular/angular-1.0.1.min.js"></script>
    <script type="text/javascript" src="/js/content/js/moment.min.js"></script>
    <script type="text/javascript" src="/js/content/My97DatePicker/WdatePicker.js"></script>
    <script type="text/javascript" src="/js/scripts/modules/aitatask.js"></script>
    <script type="text/javascript" src="/js/scripts/controllers/getTasksByAssignee.js"></script>
    <!-- end -->
</head>
<body>
    <div class="wrap" ng-app="aitatask">
        <!-- header:S -->
        <div class="header">
            <div class="header-main">
                <div class="header-right">
                    <div class="head-msg">
                        <span class="number-float">234</span> <i class="group-icon">&nbsp;</i> <i class="email-icon">
                            &nbsp;</i> <i class="newms-icon">&nbsp;</i>
                    </div>
                    <ul class="menu">
                        <li class="current"><a href="">首页</a></li>
                        <li><a href="">任务</a></li>
                        <li><a href="">群</a></li>
                        <li><a href="">话题</a></li>
                        <li><a href="">应用</a></li>
                        <li><a href="">导航</a></li>
                    </ul>
                    <div class="search-box">
                        <form action="" method="get">
                        <input class="search-text" id="search-text" type="text" value="" />
                        <input type="button" class="search-but" />
                        </form>
                    </div>
                </div>
                <h1 class="logo">
                    <a href="/">
                        <img src="/js/Content/images/logo.jpg" /></a></h1>
            </div>
        </div>
        <!-- header:E -->
        <!-- taskmain:S-->
        <div class="main-box" ng-controller="GetTasksByAssigneeCtrl">
			<div class="task-left">
				<div class="add-task-ico">
					<a href="/CreateTask.htm?userId={{userId}}" title="添加任务">+</a>
				</div>
				<div class="task-left-tag">
					<a class="a1 on" href="/GetTasksByAssignee.htm?userId={{userId}}">
						<span></span>
						待办任务
					</a>
					<a class="a2" href="/GetRelatedTasks.htm?userId={{userId}}">
						<span></span>
						相关任务
					</a>
					<a class="a3" href="/GetTasksByCreator.htm?userId={{userId}}">
						<span></span>
						我创建的任务
					</a>
				</div>
			</div>
			<div class="task-right">
				<div class="nav">
					<span class="s1"><b>待办任务：</b></span>
					<span class="s2 hide-cooper" id="optionPanel" style="display:none;">
                        <a ng-class="meAssigntoMeIcon()" ng-Click="chooseMeAssigntoMe()">{{meAssigntoMe.name}}（{{meAssigntoMe.count}}）</a>
                        <a ng-class="otherAssignToMeIcon()" ng-Click="chooseOtherAssignToMe()">{{otherAssignToMe.name}}（{{otherAssignToMe.count}}）</a>
                        <a ng-class="sourceIcon(s)" ng-Click="chooseSource(s)" ng-repeat="s in sources">{{s.name}}（{{s.count}}）</a>
					</span>
					<div class="clearbox"></div>
				</div>
				<div class="paixu">
					<div class="paixu-1" id="displayMode">
						<font color=#000>排序：</font>
						<a class="paixu-on" displayMode="1">默认</a>
						&nbsp;&nbsp;|&nbsp;&nbsp;
						<a displayMode="2">优先级</a>
					</div>
					<div class="paixu-2">
						<input type="text" id="task-keyword" placeholder="请输入关键字" />
					</div>
					<div class="paixu-3">
						<input type="checkbox" id="hideCompletedOption" style="vertical-align:middle"/><span style="vertical-align:middle">&nbsp;&nbsp;隐藏已完成任务</span>
					</div>
				</div>
				<div class="task-content" id="task-content">
					<div class="task-content-div task-content-div-t">
						<ul>
							<li class="l1"></li>
							<li class="l2">任务来源</li>
							<li class="l3">摘要</li>
							<li class="l5">完成时间/优先级</li>
						</ul>
					</div>
                    <div ng-show="equalDisplayMode(1)" class="task-content-div" 
                            ng-repeat="t in tasks">
						<ul>
							<li class="l1" ng-click="setIsCompleted(t,!t.isCompleted);"><i ng-class="completedIcon(t)"></i></li>
							<li class="l2"><del ng-show="t.isCompleted==true">{{t.source}}</del><span ng-show="t.isCompleted==false">{{t.source}}</span></li>
							<li class="l3 txtCut " style="width:500px">
                                <del ng-show="t.isCompleted==true"><a ng-href="{{openUrl(t)}}">{{t.subject}}</a>&nbsp;-&nbsp;{{t.body}}</del>
                                <span ng-show="t.isCompleted==false"><a ng-href="{{openUrl(t)}}">{{t.subject}}</a>&nbsp;-&nbsp;{{t.body}}</span>
                            </li>
							<li class="l4"><i id="priority1_{{t.id}}" ng-click="showPriorityPanel(t,1)" ng-class="priorityIcon(t)">{{getFormatPriority(t.priority)}}</i></li>
							<li class="l5">
								<input class="txtDate" type="text" onchange="changeDueTime({{t}},this)" onfocus="openDatePicker({{t}},this)" value="{{getFormatDate(t.dueTime)}}" size="16" readonly>
                                <input id="hidDueTime_{{t.id}}" type="hidden" />
							</li>
						</ul>
					</div>
                    <div ng-show="equalDisplayMode(2)" ng-repeat="(key,value) in taskDict">
                        <div class="task-content-date">
							<b>{{getPriorityName(key)}}</b>
						</div>
                        <div class="task-content-div" ng-repeat="t in value">
							<ul>
								<li class="l1" ng-click="setIsCompleted(t,!t.isCompleted);"><i ng-class="completedIcon(t)"></i></li>
								<li class="l2"><del ng-show="t.isCompleted==true">{{t.source}}</del><span ng-show="t.isCompleted==false">{{t.source}}</span></li>
								<li class="l3 txtCut " style="width:500px">
                                    <del ng-show="t.isCompleted==true"><a ng-href="{{openUrl(t)}}">{{t.subject}}</a>&nbsp;-&nbsp;{{t.body}}</del>
                                    <span ng-show="t.isCompleted==false"><a ng-href="{{openUrl(t)}}">{{t.subject}}</a>&nbsp;-&nbsp;{{t.body}}</span>
                                </li>
								<li class="l4"><i id="priority2_{{t.id}}" ng-click="showPriorityPanel(t,2)" ng-class="priorityIcon(t)">{{getFormatPriority(t.priority)}}</i></li>
								<li class="l5">
									<input class="txtDate" type="text" onchange="changeDueTime({{t}},this)" onfocus="openDatePicker({{t}},this)" value="{{getFormatDate(t.dueTime)}}" size="16" readonly>
								</li>
							</ul>
						</div>
                    </div>	         
				</div>
			</div>
            <div class="clearbox"></div>
        </div>
        <!-- taskmain:E-->
    </div>

    <script type="text/javascript">
        var map_url = isPhp ? '/task/request' : '/Handlers/UrlMapHandler.ashx'; //TODO:Php
        var changeDueTime_call = isPhp ? 'ChangeDueTime' : 'url_changeDueTime'; //TODO:Php
        function openDatePicker(task, element) {
            var taskId = task.id;
            var elementId = element.id;
            WdatePicker(
                {
                    el: elementId,
                    dateFmt: 'yyyy-MM-dd',
                    errDealMode: 2
                });
        }
        function changeDueTime(task, element) {
            var taskId = task.id;
            var dueTime;
            if($(element).val() == '') {
                $(element).val('待定');
                dueTime = null;
            }
            else {
                var longdate = $(element).val();
                var shortdate = moment(longdate).format('MM-DD');
                $(element).val(shortdate);
                dueTime = longdate;
            }
            var data = {
                id: taskId,
                dueTime: dueTime,
                call: changeDueTime_call
            };
            var url = isPhp ? map_url + '?_=' + new Date().getTime()
                : map_url + '?url=' + changeDueTime_call + '&_=' + new Date().getTime();
            $.get(url, data, function (result) {
                var obj = angular.fromJson(result);
                if (obj.state == 0) {

                }
                else {
                    alert(result.data);
                }
            });
        }
    </script>
</body>
</html>