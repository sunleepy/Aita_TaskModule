<!DOCTYPE html>
<html>
<head>
    <title>待办任务</title>
    <link type="text/css" rel="Stylesheet" href="/content/bootstrap/css/bootstrap.min.css" />
    <link type="text/css" rel="Stylesheet" href="/content/css/base.css" />
    <script src="/Content/jquery/jquery-1.7.2.min.js"></script>
    <script src="/Content/angular/angular-1.0.1.min.js"></script>
    <script src="/Content/js/moment.min.js"></script>
    <script src="/Content/My97DatePicker/WdatePicker.js"></script>
    <script src="/Scripts/enterprise.js"></script>
    <script src="/Scripts/modules/aitatask.js"></script>
    <script src="/Scripts/controllers/getTasksByAssignee.js"></script>
</head>
<body>
    <div class="container-fluid" style="margin-top:10px;" ng-app="aitatask">
        <div>
            <h4>待办任务</h4>
            <hr />
        </div>
        <div id="loading-cooper" style="display:none;">
            <div class="progress progress-striped active" style="width: 250px; margin: auto;
                margin-top: 40px;">
                <div class="bar" style="width: 100%;">
                    loading...</div>
            </div>
        </div>
        <div id="main-cooper" ng-controller="GetTasksByAssigneeCtrl" style="display:none;">
        <div class="option">
            <button ng-class="meAssigntoMeIcon()" ng-Click="chooseMeAssigntoMe()">
            {{meAssigntoMe.name}}({{meAssigntoMe.count}})</button>
            <button ng-class="otherAssignToMeIcon()" ng-Click="chooseOtherAssignToMe()">
            {{otherAssignToMe.name}}({{otherAssignToMe.count}})</button>
            <button ng-class="sourceIcon(s)" ng-repeat="s in sources" ng-Click="chooseSource(s)">
            {{s.name}}({{s.count}})</button>
        </div>
        <div>
            <table>
                <tr>
                    <td style="width:40px;">
                        排序：
                    </td>
                    <td style="width:120px;">
                        <div id="displayMode" class="btn-group">
                              <button class="btn active" displayMode="1">默认</button>
                              <button class="btn" displayMode="2">优先级</button>
                        </div>
                    </td>
                    <td style="padding-top:10px;width:180px;">
                        <input id="keyWord" type="text" placeholder="请输入关键字" class="input-medium" />
                    </td>
                    <td>
                         <label for="hideCompletedOption"><input id="hideCompletedOption" type="checkbox" /> 隐藏已完成任务</label>
                    </td>
                </tr>
            </table>
        </div>
        <div class="list">
            <table class="todolist table">
                <thead>
                    <tr class="row_header">
                        <td class="cell_isCompleted"></td>
                        <td class="cell_source">任务来源</td>
                        <td class="cell_summary">摘要</td>
                        <td class="cell_dueTime">完成时间/优先级</td>
                    </tr>
                </thead>
                <tbody ng-show="equalDisplayMode(1)">
                    <tr class="row_body" ng-repeat="t in tasks">
                        <td class="cell_isCompleted" ng-click="setIsCompleted(t,!t.isCompleted);">
                            <i ng-class="completedIcon(t);"></i>
                        </td>
                        <td>
                            {{t.source}}
                        </td>
                        <td class="cell_summary">
                            <a ng-href="{{openUrl(t)}}" target="_blank">{{t.subject}}&nbsp; &nbsp; -&nbsp; &nbsp; {{t.body}}</a>
                        </td>
                        <td>
                            <span id="picker_{{t.id}}" onclick="openWdatePicker('{{t.id}}');">
                                {{getFormatDate(t.dueTime)}}</span> 
                            <img id="priority_{{t.id}}" src="/content/images/priority_{{getFormatPriority(t.priority)}}.png" ng-click="showPriorityPanel(t)"/>
                            <div id="showPriority_{{t.id}}" style="border:1px solid #000; width:50px; height:80px; display:none;">
                                <img tag="0" src="/content/images/priority_0.png" /><br />
                                <img tag="1" src="/content/images/priority_1.png" /><br />
                                <img tag="2" src="/content/images/priority_2.png" /><br />
                            </div>
                        </td>
                    </tr>
                </tbody>
                <tbody ng-show="equalDisplayMode(2)">
                    <tr ng-repeat="(key, value) in taskDict">
                        <td colspan="4">
                            <table class="table">
                                <tr>
                                    {{key}} 
                                </tr>
                                <tr class="row_body" ng-repeat="t in value">
                                    <td class="cell_isCompleted" ng-click="setIsCompleted(t,!t.isCompleted);">
                                        <i ng-class="completedIcon(t);"></i>
                                    </td>
                                    <td>
                                        {{t.source}}
                                    </td>
                                    <td class="cell_summary">
                                        <a ng-href="{{openUrl(t)}}" target="_blank">{{t.subject}}&nbsp; &nbsp; -&nbsp; &nbsp; {{t.body}}</a>
                                        <!--<div class="summary">{{t.subject}}<span style="color:Gray;">&nbsp; &nbsp; -&nbsp; &nbsp; {{t.body}}</span></div>-->
                                    </td>
                                    <td>
                                        <span id="picker_{{t.id}}" onclick="openWdatePicker('{{t.id}}');">
                                            {{getFormatDate(t.dueTime)}}</span> 
                                        <img id="priority2_{{t.id}}" src="/content/images/priority_{{getFormatPriority(t.priority)}}.png" ng-click="showPriorityPanel2(t)"/>
                                        <div id="showPriority2_{{t.id}}" style="border:1px solid #000; width:50px; height:80px; display:none;">
                                            <img tag="0" src="/content/images/priority_0.png" /><br />
                                            <img tag="1" src="/content/images/priority_1.png" /><br />
                                            <img tag="2" src="/content/images/priority_2.png" /><br />
                                        </div>
                                    </td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                </tbody>
        </table>
        </div>
    </div>
    </div>
    <script>
        var url_changeDueTime = 'url_changeDueTime';
        function openWdatePicker(taskId) {
            var elementId = 'picker_' + taskId;
            WdatePicker(
                {
                    el: elementId,
                    dateFmt: 'yyyy-MM-dd',
                    errDealMode: 2,
                    oncleared: function () {
                        $('#' + elementId).html('待定');

                        var data = {
                            id: taskId,
                            dueTime: null
                        };
                        $.get('/Handlers/UrlMapHandler.ashx?url=' + url_changeDueTime, data, function (result) {
                            var obj = angular.fromJson(result);
                            if (obj.state == 0) {
                                
                            }
                            else {
                                alert(result.data);
                            }
                        });
                    },
                    onpicked: function () {
                        var longdate = $('#' + elementId).html();
                        var shortdate = moment($('#' + elementId).html()).format('MM-DD');
                        $('#' + elementId).html(shortdate);
                        var data = {
                            id: taskId,
                            dueTime: longdate
                        };
                        $.get('/Handlers/UrlMapHandler.ashx?url=' + url_changeDueTime, data, function (result) {
                            var obj = angular.fromJson(result);
                            if (obj.state == 0) {
                                
                            }
                            else {
                                alert(result.data);
                            }
                        });
                    }
                });
            }

            function showPriorityPanel(task) {
                alert('1');
 

                $('#priority_' + task.id).tooltip({
                    placement: 'top',
                    trigger: 'hover',
                    title: 'test'
                })
            }
    </script>
</body>
</html>